import{d as j,r as I,c as S,a as h,b as f,w as u,e as k,u as $,f as lt,g as V,o as E,h as et,i as z,n as N,F as ht,j as rt,k as dt,t as G,l as ct,m as ut,p as Z,q as pt,s as K,z as gt,v as mt,x as tt,y as Y,A as ft,B as it,E as L}from"./index-IdqsJTIZ.js";import{_ as H,e as _t,d as st,g as wt,c as vt,a as xt,b as yt}from"./imageUtils-eH2jUJ3Y.js";const bt={class:"image-uploader"},Mt=j({__name:"ImageUploader",emits:["change"],setup(l,{emit:t}){const e=t,i=I([]),s=n=>{n.raw&&e("change",[n.raw])};return(n,a)=>{const d=f("el-icon"),o=f("el-upload");return E(),S("div",bt,[h(o,{"file-list":i.value,"onUpdate:fileList":a[0]||(a[0]=p=>i.value=p),"auto-upload":!1,"on-change":s,"show-file-list":!1,multiple:!0,accept:"image/*",drag:"",class:"upload-dragger"},{tip:u(()=>[...a[1]||(a[1]=[k("div",{class:"el-upload__tip"}," 支持 jpg/png/gif/webp 格式的图片文件 ",-1)])]),default:u(()=>[h(d,{class:"el-icon--upload"},{default:u(()=>[h($(lt))]),_:1}),a[2]||(a[2]=k("div",{class:"el-upload__text"},[V(" 将文件拖到此处，或"),k("em",null,"点击上传")],-1))]),_:1},8,["file-list"])])}}}),It=H(Mt,[["__scopeId","data-v-8c9b5dea"]]),kt=et("image",{state:()=>({images:[],selectedImages:[]}),getters:{imageCount:l=>l.images.length,selectedCount:l=>l.selectedImages.length,hasImages:l=>l.images.length>0},actions:{addImage(l){this.images.push(l)},removeImage(l){const t=this.images.findIndex(e=>e.id===l);if(t>-1){const e=this.images[t];URL.revokeObjectURL(e.url),this.images.splice(t,1),this.removeSelected(l)}},clearImages(){this.images.forEach(l=>URL.revokeObjectURL(l.url)),this.images=[],this.selectedImages=[]},toggleSelect(l){const t=this.selectedImages.indexOf(l);t>-1?this.selectedImages.splice(t,1):this.selectedImages.push(l)},removeSelected(l){const t=this.selectedImages.indexOf(l);t>-1&&this.selectedImages.splice(t,1)},selectAll(){this.selectedImages=this.images.map(l=>l.id)},clearSelection(){this.selectedImages=[]}}}),Et=["src","alt"],Rt=j({__name:"Image",props:{src:{},alt:{},width:{},height:{},fit:{}},setup(l){const t=l,e=z(()=>t.alt??"");function i(a){if(a!==void 0)return typeof a=="number"?`${a}px`:a}const s=z(()=>{const a={},d=i(t.width),o=i(t.height);return d&&(a.width=d),o&&(a.height=o),a}),n=z(()=>({objectFit:t.fit??"contain",maxWidth:"100%",maxHeight:"100%"}));return(a,d)=>(E(),S("div",{class:"image-wrapper",style:N(s.value)},[k("img",{src:l.src,alt:e.value,style:N(n.value),draggable:"false"},null,12,Et)],4))}}),at=H(Rt,[["__scopeId","data-v-3437824a"]]),Ut={class:"image-list"},St={key:0,class:"empty-state"},Bt={key:1,class:"image-grid"},Ot=["onClick"],Vt={class:"image-preview"},Ct={class:"image-info"},At=["title"],Wt={class:"image-size"},$t=j({__name:"ImageList",props:{images:{}},emits:["remove"],setup(l,{emit:t}){const e=t,i=kt(),s=d=>i.selectedImages.includes(d),n=d=>{i.toggleSelect(d)},a=d=>{e("remove",d)};return(d,o)=>{const p=f("el-empty"),m=f("el-button");return E(),S("div",Ut,[l.images.length===0?(E(),S("div",St,[h(p,{description:"暂无图片"})])):(E(),S("div",Bt,[(E(!0),S(ht,null,rt(l.images,r=>(E(),S("div",{key:r.id,class:dt(["image-item",{selected:s(r.id)}]),onClick:y=>n(r.id)},[k("div",Vt,[h(at,{src:r.url,alt:r.name,fit:"contain"},null,8,["src","alt"])]),k("div",Ct,[k("div",{class:"image-name",title:r.name},G(r.name),9,At),k("div",Wt,G(r.width)+" × "+G(r.height),1)]),h(m,{class:"remove-btn",type:"danger",icon:$(ut),circle:"",size:"small",onClick:ct(y=>a(r.id),["stop"])},null,8,["icon","onClick"])],10,Ot))),128))]))])}}}),zt=H($t,[["__scopeId","data-v-63bddcd6"]]),Tt={class:"sprite-preview"},Lt={key:0,class:"empty-state"},jt={key:1,class:"preview-container"},Ht={class:"preview-toolbar"},Pt={class:"zoom-info"},Dt=j({__name:"SpritePreview",props:{canvas:{}},setup(l){const t=l,e=I(),i=I(),s=I(1),n=I(0),a=I(0),d=I(!1),o=I({x:0,y:0}),p=z(()=>{var c;return(c=t.canvas)==null?void 0:c.toDataURL()}),m=()=>{if(!t.canvas||!e.value)return 1;const c=t.canvas,R=e.value,O=R.clientWidth-40,B=R.clientHeight-40,P=c.width,T=c.height,A=O/P,W=B/T,Q=Math.min(A,W,1);return Math.max(.1,Q)},r=()=>{if(!t.canvas||!e.value)return;const c=m();s.value=c,n.value=0,a.value=0},y=()=>{s.value=Math.min(s.value+.1,3)},w=()=>{s.value=Math.max(s.value-.1,.1)},v=()=>{r()},_=c=>{c.preventDefault();const R=c.deltaY>0?-.1:.1;s.value=Math.max(.1,Math.min(3,s.value+R))},U=c=>{c.button===0&&(c.preventDefault(),d.value=!0,o.value={x:c.clientX-n.value,y:c.clientY-a.value})},b=c=>{d.value&&(n.value=c.clientX-o.value.x,a.value=c.clientY-o.value.y)},x=()=>{d.value=!1},g=()=>{K(()=>{r()})};return Z(()=>t.canvas,()=>{K(()=>{r()})}),pt(()=>{const c=new ResizeObserver(()=>{t.canvas&&r()});e.value&&c.observe(e.value),t.canvas&&K(()=>{r()})}),(c,R)=>{var T,A;const O=f("el-empty"),B=f("el-button"),P=f("el-button-group");return E(),S("div",Tt,[p.value?(E(),S("div",jt,[k("div",Ht,[h(P,null,{default:u(()=>[h(B,{icon:$(gt),onClick:y},null,8,["icon"]),h(B,{icon:$(mt),onClick:w},null,8,["icon"]),h(B,{onClick:v},{default:u(()=>[...R[0]||(R[0]=[V("重置",-1)])]),_:1})]),_:1}),k("div",Pt,"缩放: "+G((s.value*100).toFixed(0))+"%",1)]),k("div",{class:"preview-content",ref_key:"previewRef",ref:e,onWheel:_,onMousedown:U,onMousemove:b,onMouseup:x,onMouseleave:x},[k("div",{class:"image-wrapper",style:N({transform:`scale(${s.value}) translate(${n.value}px, ${a.value}px)`})},[h(at,{ref_key:"imgRef",ref:i,src:p.value,alt:"合图预览",fit:"contain",width:(T=l.canvas)==null?void 0:T.width,height:(A=l.canvas)==null?void 0:A.height,onLoad:g},null,8,["src","width","height"])],4)],544)])):(E(),S("div",Lt,[h(O,{description:"暂无合图预览"})]))])}}}),Xt=H(Dt,[["__scopeId","data-v-969a8aa4"]]),qt={class:"pack-options"},Ft=j({__name:"SimplePackOptions",props:{modelValue:{}},emits:["update:modelValue"],setup(l,{emit:t}){const e=l,i=t,s=z(()=>e.modelValue);function n(o){i("update:modelValue",{...s.value,...o})}const a=o=>{n({padding:o??0})},d=o=>{n({maxWidth:o??4096})};return(o,p)=>{const m=f("el-input-number"),r=f("el-form-item"),y=f("el-alert");return E(),S("div",qt,[h(r,{label:"子图间距"},{default:u(()=>[h(m,{"model-value":s.value.padding??0,min:0,max:50,"onUpdate:modelValue":a},null,8,["model-value"])]),_:1}),h(r,{label:"最大宽度"},{default:u(()=>[h(m,{"model-value":s.value.maxWidth??4096,min:256,max:8192,step:256,"onUpdate:modelValue":d},null,8,["model-value"])]),_:1}),h(r,null,{default:u(()=>[h(y,{title:"简单排列按顺序逐行放置图片，适合数量较少或尺寸接近的图片。",type:"info",closable:!1,"show-icon":"",class:"algorithm-tip"})]),_:1})])}}}),Gt=H(Ft,[["__scopeId","data-v-7c0790ba"]]),Yt={class:"pack-options"},Zt=j({__name:"BinPackingOptions",props:{modelValue:{}},emits:["update:modelValue"],setup(l,{emit:t}){const e=l,i=t,s=z(()=>e.modelValue);function n(_){i("update:modelValue",{...s.value,..._})}const a=_=>{n({padding:_??0})},d=_=>{n({maxWidth:_??2048})},o=_=>{n({maxHeight:_??2048})},p=_=>{n({powerOfTwo:!!_})},m=_=>{n({smart:_??!0})},r=_=>{n({square:!!_})},y=_=>{n({allowRotation:!!_})},w=_=>{n({border:_??0})},v=_=>{n({logic:_??"max-edge"})};return(_,U)=>{const b=f("el-input-number"),x=f("el-form-item"),g=f("el-switch"),c=f("el-option"),R=f("el-select"),O=f("el-alert");return E(),S("div",Yt,[h(x,{label:"子图间距"},{default:u(()=>[h(b,{"model-value":s.value.padding??0,min:0,max:50,"onUpdate:modelValue":a},null,8,["model-value"])]),_:1}),h(x,{label:"最大宽度"},{default:u(()=>[h(b,{"model-value":s.value.maxWidth??2048,min:256,max:8192,step:256,"onUpdate:modelValue":d},null,8,["model-value"])]),_:1}),h(x,{label:"最大高度"},{default:u(()=>[h(b,{"model-value":s.value.maxHeight??2048,min:256,max:8192,step:256,"onUpdate:modelValue":o},null,8,["model-value"])]),_:1}),h(x,{label:"2 的幂次方"},{default:u(()=>[h(g,{"model-value":s.value.powerOfTwo??!1,"onUpdate:modelValue":p},null,8,["model-value"])]),_:1}),h(x,{label:"智能模式"},{default:u(()=>[h(g,{"model-value":s.value.smart??!0,"onUpdate:modelValue":m},null,8,["model-value"])]),_:1}),h(x,{label:"正方形画布"},{default:u(()=>[h(g,{"model-value":s.value.square??!1,"onUpdate:modelValue":r},null,8,["model-value"])]),_:1}),h(x,{label:"允许旋转"},{default:u(()=>[h(g,{"model-value":s.value.allowRotation??!1,"onUpdate:modelValue":y},null,8,["model-value"])]),_:1}),h(x,{label:"边缘留白"},{default:u(()=>[h(b,{"model-value":s.value.border??0,min:0,max:512,"onUpdate:modelValue":w},null,8,["model-value"])]),_:1}),h(x,{label:"排序逻辑"},{default:u(()=>[h(R,{"model-value":s.value.logic??"max-edge",placeholder:"选择逻辑","onUpdate:modelValue":v},{default:u(()=>[h(c,{label:"按边长优先",value:"max-edge"}),h(c,{label:"按面积优先",value:"max-area"})]),_:1},8,["model-value"])]),_:1}),h(x,null,{default:u(()=>[h(O,{title:"最优打包使用 MaxRects 算法，布局更紧凑，适合大批量或尺寸差异大的图片。",type:"success",closable:!1,"show-icon":"",class:"algorithm-tip"})]),_:1})])}}}),Jt=H(Zt,[["__scopeId","data-v-5db477d3"]]),Qt={class:"config-editor"},Kt={class:"json-actions"},Nt=j({__name:"ConfigEditor",props:{options:{},config:{}},emits:["update:options"],setup(l,{emit:t}){const e={simple:Gt,"bin-packing":Jt},i=l,s=t,n=I("options"),a=I({...i.options}),d=z(()=>{const w=a.value.algorithm??"simple";return e[w]??null}),o=z(()=>i.config?_t(i.config):""),p=()=>{s("update:options",{...a.value})},m=w=>{a.value={...a.value,...w,algorithm:a.value.algorithm},s("update:options",{...a.value})},r=async()=>{if(!o.value){L.warning("暂无配置可复制");return}try{await navigator.clipboard.writeText(o.value),L.success("配置已复制到剪贴板")}catch{L.error("复制失败")}},y=w=>{if(!i.config){L.warning("暂无配置可下载");return}const v=w==="plist"?"sprite-config.plist":"sprite-config.json";st(i.config,v),L.success(`配置已下载为 ${w.toUpperCase()} 格式`)};return Z(()=>i.options,w=>{a.value={...w}},{deep:!0}),Z(()=>a.value.algorithm,()=>{p()}),(w,v)=>{const _=f("el-option"),U=f("el-select"),b=f("el-form-item"),x=f("el-form"),g=f("el-tab-pane"),c=f("el-input"),R=f("el-button"),O=f("el-icon"),B=f("el-dropdown-item"),P=f("el-dropdown-menu"),T=f("el-dropdown"),A=f("el-tabs");return E(),S("div",Qt,[h(A,{modelValue:n.value,"onUpdate:modelValue":v[2]||(v[2]=W=>n.value=W)},{default:u(()=>[h(g,{label:"配置选项",name:"options"},{default:u(()=>[h(x,{model:a.value,"label-width":"120px"},{default:u(()=>[h(b,{label:"排列算法"},{default:u(()=>[h(U,{modelValue:a.value.algorithm,"onUpdate:modelValue":v[0]||(v[0]=W=>a.value.algorithm=W),placeholder:"选择算法",onChange:p},{default:u(()=>[h(_,{label:"简单排列",value:"simple"}),h(_,{label:"最优打包",value:"bin-packing"})]),_:1},8,["modelValue"])]),_:1}),d.value?(E(),tt(ft(d.value),{key:a.value.algorithm,"model-value":a.value,"onUpdate:modelValue":m},null,8,["model-value"])):Y("",!0)]),_:1},8,["model"])]),_:1}),h(g,{label:"JSON配置",name:"json"},{default:u(()=>[h(c,{modelValue:o.value,"onUpdate:modelValue":v[1]||(v[1]=W=>o.value=W),type:"textarea",rows:15,readonly:"",class:"json-editor"},null,8,["modelValue"]),k("div",Kt,[h(R,{type:"primary",onClick:r},{default:u(()=>[...v[3]||(v[3]=[V("复制配置",-1)])]),_:1}),h(T,{onCommand:y},{dropdown:u(()=>[h(P,null,{default:u(()=>[h(B,{command:"json"},{default:u(()=>[...v[5]||(v[5]=[V("下载为 JSON",-1)])]),_:1}),h(B,{command:"plist"},{default:u(()=>[...v[6]||(v[6]=[V("下载为 PLIST",-1)])]),_:1})]),_:1})]),default:u(()=>[h(R,{type:"success"},{default:u(()=>[v[4]||(v[4]=V(" 下载配置",-1)),h(O,{class:"el-icon--right"},{default:u(()=>[h($(it))]),_:1})]),_:1})]),_:1})])]),_:1})]),_:1},8,["modelValue"])])}}}),te=H(Nt,[["__scopeId","data-v-17cd3e4a"]]);function ee(){const l=I([]),t=I(!1),e=I(null);async function i(d){t.value=!0,e.value=null;try{const o=Array.from(d),p=await Promise.all(o.map(m=>wt(m)));l.value.push(...p)}catch(o){throw e.value=o instanceof Error?o.message:"图片加载失败",o}finally{t.value=!1}}function s(d){const o=l.value.findIndex(p=>p.id===d);if(o>-1){const p=l.value[o];URL.revokeObjectURL(p.url),l.value.splice(o,1)}}function n(){l.value.forEach(d=>URL.revokeObjectURL(d.url)),l.value=[]}function a(d,o){const p=l.value.findIndex(m=>m.id===d);p>-1&&(l.value[p]={...l.value[p],...o})}return{images:l,loading:t,error:e,addImages:i,removeImage:s,clearImages:n,updateImage:a}}class M{constructor(t=0,e=0,i=0,s=0,n=!1,a=void 0){this.oversized=!1,this._rot=!1,this._allowRotation=void 0,this._dirty=0,this._width=t,this._height=e,this._x=i,this._y=s,this._data={},this._rot=n,this._allowRotation=a}static Collide(t,e){return t.collide(e)}static Contain(t,e){return t.contain(e)}area(){return this.width*this.height}collide(t){return t.x<this.x+this.width&&t.x+t.width>this.x&&t.y<this.y+this.height&&t.y+t.height>this.y}contain(t){return t.x>=this.x&&t.y>=this.y&&t.x+t.width<=this.x+this.width&&t.y+t.height<=this.y+this.height}get width(){return this._width}set width(t){t!==this._width&&(this._width=t,this._dirty++)}get height(){return this._height}set height(t){t!==this._height&&(this._height=t,this._dirty++)}get x(){return this._x}set x(t){t!==this._x&&(this._x=t,this._dirty++)}get y(){return this._y}set y(t){t!==this._y&&(this._y=t,this._dirty++)}get rot(){return this._rot}set rot(t){if(this._allowRotation!==!1&&this._rot!==t){const e=this.width;this.width=this.height,this.height=e,this._rot=t,this._dirty++}}get allowRotation(){return this._allowRotation}set allowRotation(t){this._allowRotation!==t&&(this._allowRotation=t,this._dirty++)}get data(){return this._data}set data(t){t===null||t===this._data||(this._data=t,typeof t=="object"&&t.hasOwnProperty("allowRotation")&&(this._allowRotation=t.allowRotation),this._dirty++)}get dirty(){return this._dirty>0}setDirty(t=!0){this._dirty=t?this._dirty+1:0}}class nt{constructor(){this._dirty=0}get dirty(){return this._dirty>0||this.rects.some(t=>t.dirty)}setDirty(t=!0){if(this._dirty=t?this._dirty+1:0,!t)for(let e of this.rects)e.setDirty&&e.setDirty(!1)}}class q extends nt{constructor(t=J,e=J,i=0,s={}){super(),this.maxWidth=t,this.maxHeight=e,this.padding=i,this.freeRects=[],this.rects=[],this.verticalExpand=!1,this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:C.MAX_EDGE},this.options=Object.assign(Object.assign({},this.options),s),this.width=this.options.smart?0:t,this.height=this.options.smart?0:e,this.border=this.options.border?this.options.border:0,this.freeRects.push(new M(this.maxWidth+this.padding-this.border*2,this.maxHeight+this.padding-this.border*2,this.border,this.border)),this.stage=new M(this.width,this.height)}add(...t){let e,i;if(t.length===1){if(typeof t[0]!="object")throw new Error("MacrectsBin.add(): Wrong parameters");i=t[0];let n=i.data&&i.data.tag?i.data.tag:i.tag?i.tag:void 0;if(this.options.tag&&this.options.exclusiveTag&&this.tag!==n)return}else{if(e=t.length>2?t[2]:null,this.options.tag&&this.options.exclusiveTag&&(e&&this.tag!==e.tag||!e&&this.tag))return;i=new M(t[0],t[1]),i.data=e,i.setDirty(!1)}const s=this.place(i);return s&&this.rects.push(s),s}repack(){let t=[];this.reset(),this.rects.sort((e,i)=>{const s=Math.max(i.width,i.height)-Math.max(e.width,e.height);return s===0&&e.hash&&i.hash?e.hash>i.hash?-1:1:s});for(let e of this.rects)this.place(e)||t.push(e);for(let e of t)this.rects.splice(this.rects.indexOf(e),1);return t.length>0?t:void 0}reset(t=!1,e=!1){t&&(this.data&&delete this.data,this.tag&&delete this.tag,this.rects=[],e&&(this.options={smart:!0,pot:!0,square:!0,allowRotation:!1,tag:!1,border:0})),this.width=this.options.smart?0:this.maxWidth,this.height=this.options.smart?0:this.maxHeight,this.border=this.options.border?this.options.border:0,this.freeRects=[new M(this.maxWidth+this.padding-this.border*2,this.maxHeight+this.padding-this.border*2,this.border,this.border)],this.stage=new M(this.width,this.height),this._dirty=0}clone(){let t=new q(this.maxWidth,this.maxHeight,this.padding,this.options);for(let e of this.rects)t.add(e);return t}place(t){let e=t.data&&t.data.tag?t.data.tag:t.tag?t.tag:void 0;if(this.options.tag&&this.options.exclusiveTag&&this.tag!==e)return;let i,s;if(t.hasOwnProperty("_allowRotation")&&t.allowRotation!==void 0?s=t.allowRotation:s=this.options.allowRotation,i=this.findNode(t.width+this.padding,t.height+this.padding,s),i){this.updateBinSize(i);let n=this.freeRects.length,a=0;for(;a<n;)this.splitNode(this.freeRects[a],i)&&(this.freeRects.splice(a,1),n--,a--),a++;return this.pruneFreeList(),this.verticalExpand=this.width>this.height,t.x=i.x,t.y=i.y,t.rot===void 0&&(t.rot=!1),t.rot=i.rot?!t.rot:t.rot,this._dirty++,t}else if(this.verticalExpand){if(this.updateBinSize(new M(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border))||this.updateBinSize(new M(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border)))return this.place(t)}else if(this.updateBinSize(new M(t.width+this.padding,t.height+this.padding,this.width+this.padding-this.border,this.border))||this.updateBinSize(new M(t.width+this.padding,t.height+this.padding,this.border,this.height+this.padding-this.border)))return this.place(t)}findNode(t,e,i){let s=Number.MAX_VALUE,n,a,d;for(let o in this.freeRects)a=this.freeRects[o],a.width>=t&&a.height>=e&&(n=this.options.logic===C.MAX_AREA?a.width*a.height-t*e:Math.min(a.width-t,a.height-e),n<s&&(d=new M(t,e,a.x,a.y),s=n)),i&&a.width>=e&&a.height>=t&&(n=this.options.logic===C.MAX_AREA?a.width*a.height-e*t:Math.min(a.height-t,a.width-e),n<s&&(d=new M(e,t,a.x,a.y,!0),s=n));return d}splitNode(t,e){if(!t.collide(e))return!1;if(e.x<t.x+t.width&&e.x+e.width>t.x){if(e.y>t.y&&e.y<t.y+t.height){let i=new M(t.width,e.y-t.y,t.x,t.y);this.freeRects.push(i)}if(e.y+e.height<t.y+t.height){let i=new M(t.width,t.y+t.height-(e.y+e.height),t.x,e.y+e.height);this.freeRects.push(i)}}if(e.y<t.y+t.height&&e.y+e.height>t.y){if(e.x>t.x&&e.x<t.x+t.width){let i=new M(e.x-t.x,t.height,t.x,t.y);this.freeRects.push(i)}if(e.x+e.width<t.x+t.width){let i=new M(t.x+t.width-(e.x+e.width),t.height,e.x+e.width,t.y);this.freeRects.push(i)}}return!0}pruneFreeList(){let t=0,e=0,i=this.freeRects.length;for(;t<i;){e=t+1;let s=this.freeRects[t];for(;e<i;){let n=this.freeRects[e];if(n.contain(s)){this.freeRects.splice(t,1),t--,i--;break}s.contain(n)&&(this.freeRects.splice(e,1),e--,i--),e++}t++}}updateBinSize(t){if(!this.options.smart||this.stage.contain(t))return!1;let e=Math.max(this.width,t.x+t.width-this.padding+this.border),i=Math.max(this.height,t.y+t.height-this.padding+this.border);if(this.options.allowRotation){const s=Math.max(this.width,t.x+t.height-this.padding+this.border),n=Math.max(this.height,t.y+t.width-this.padding+this.border);s*n<e*i&&(e=s,i=n)}return this.options.pot&&(e=Math.pow(2,Math.ceil(Math.log(e)*Math.LOG2E)),i=Math.pow(2,Math.ceil(Math.log(i)*Math.LOG2E))),this.options.square&&(e=i=Math.max(e,i)),e>this.maxWidth+this.padding||i>this.maxHeight+this.padding?!1:(this.expandFreeRects(e+this.padding,i+this.padding),this.width=this.stage.width=e,this.height=this.stage.height=i,!0)}expandFreeRects(t,e){this.freeRects.forEach((i,s)=>{i.x+i.width>=Math.min(this.width+this.padding-this.border,t)&&(i.width=t-i.x-this.border),i.y+i.height>=Math.min(this.height+this.padding-this.border,e)&&(i.height=e-i.y-this.border)},this),this.freeRects.push(new M(t-this.width-this.padding,e-this.border*2,this.width+this.padding-this.border,this.border)),this.freeRects.push(new M(t-this.border*2,e-this.height-this.padding,this.border,this.height+this.padding-this.border)),this.freeRects=this.freeRects.filter(i=>!(i.width<=0||i.height<=0||i.x<this.border||i.y<this.border)),this.pruneFreeList()}}class F extends nt{constructor(...t){if(super(),this.rects=[],t.length===1){if(typeof t[0]!="object")throw new Error("OversizedElementBin: Wrong parameters");const e=t[0];this.rects=[e],this.width=e.width,this.height=e.height,this.data=e.data,e.oversized=!0}else{this.width=t[0],this.height=t[1],this.data=t.length>2?t[2]:null;const e=new M(this.width,this.height);e.oversized=!0,e.data=this.data,this.rects.push(e)}this.freeRects=[],this.maxWidth=this.width,this.maxHeight=this.height,this.options={smart:!1,pot:!1,square:!1}}add(){}reset(t=!1){}repack(){}clone(){return new F(this.rects[0])}}const J=4096;var C;(function(l){l[l.MAX_AREA=0]="MAX_AREA",l[l.MAX_EDGE=1]="MAX_EDGE"})(C||(C={}));class ie{constructor(t=J,e=J,i=0,s={}){this.width=t,this.height=e,this.padding=i,this.options={smart:!0,pot:!0,square:!1,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:C.MAX_EDGE},this._currentBinIndex=0,this.bins=[],this.options=Object.assign(Object.assign({},this.options),s)}add(...t){if(t.length===1){if(typeof t[0]!="object")throw new Error("MacrectsPacker.add(): Wrong parameters");const e=t[0];if(e.width>this.width||e.height>this.height)this.bins.push(new F(e));else if(!this.bins.slice(this._currentBinIndex).find(s=>s.add(e)!==void 0)){let s=new q(this.width,this.height,this.padding,this.options),n=e.data&&e.data.tag?e.data.tag:e.tag?e.tag:void 0;this.options.tag&&n&&(s.tag=n),s.add(e),this.bins.push(s)}return e}else{const e=new M(t[0],t[1]);if(t.length>2&&(e.data=t[2]),e.width>this.width||e.height>this.height)this.bins.push(new F(e));else if(!this.bins.slice(this._currentBinIndex).find(s=>s.add(e)!==void 0)){let s=new q(this.width,this.height,this.padding,this.options);this.options.tag&&e.data.tag&&(s.tag=e.data.tag),s.add(e),this.bins.push(s)}return e}}addArray(t){if(!this.options.tag||this.options.exclusiveTag)this.sort(t,this.options.logic).forEach(e=>this.add(e));else{if(t.length===0)return;t.sort((n,a)=>{const d=n.data&&n.data.tag?n.data.tag:n.tag?n.tag:void 0,o=a.data&&a.data.tag?a.data.tag:a.tag?a.tag:void 0;return o===void 0?-1:d===void 0?1:o>d?-1:1});let e,i=0;if(!this.bins.slice(this._currentBinIndex).find((n,a)=>{let d=n.clone();for(let o=i;o<t.length;o++){const p=t[o],m=p.data&&p.data.tag?p.data.tag:p.tag?p.tag:void 0;if(o===0&&(e=m),m!==e)return e=m,this.sort(t.slice(i,o),this.options.logic).forEach(r=>n.add(r)),i=o,this.addArray(t.slice(o)),!0;if(m===void 0)return this.sort(t.slice(o),this.options.logic).forEach(r=>this.add(r)),i=t.length,!0;if(d.add(p)===void 0)return this.sort(t.slice(i,o),this.options.logic).forEach(r=>n.add(r)),i=o,!1}return this.sort(t.slice(i),this.options.logic).forEach(o=>n.add(o)),!0})){const n=t[i],a=new q(this.width,this.height,this.padding,this.options),d=n.data&&n.data.tag?n.data.tag:n.tag?n.tag:void 0;this.options.tag&&this.options.exclusiveTag&&d&&(a.tag=d),this.bins.push(a),a.add(n),i++,this.addArray(t.slice(i))}}}reset(){this.bins=[],this._currentBinIndex=0}repack(t=!0){if(t){let i=[];for(let s of this.bins)if(s.dirty){let n=s.repack();n&&i.push(...n)}this.addArray(i);return}if(!this.dirty)return;const e=this.rects;this.reset(),this.addArray(e)}next(){return this._currentBinIndex=this.bins.length,this._currentBinIndex}load(t){t.forEach((e,i)=>{if(e.maxWidth>this.width||e.maxHeight>this.height)this.bins.push(new F(e.width,e.height,{}));else{let s=new q(this.width,this.height,this.padding,e.options);s.freeRects.splice(0),e.freeRects.forEach((n,a)=>{s.freeRects.push(new M(n.width,n.height,n.x,n.y))}),s.width=e.width,s.height=e.height,e.tag&&(s.tag=e.tag),this.bins[i]=s}},this)}save(){let t=[];return this.bins.forEach(e=>{let i={width:e.width,height:e.height,maxWidth:e.maxWidth,maxHeight:e.maxHeight,freeRects:[],rects:[],options:e.options};e.tag&&(i=Object.assign(Object.assign({},i),{tag:e.tag})),e.freeRects.forEach(s=>{i.freeRects.push({x:s.x,y:s.y,width:s.width,height:s.height})}),t.push(i)}),t}sort(t,e=C.MAX_EDGE){return t.slice().sort((i,s)=>{const n=e===C.MAX_EDGE?Math.max(s.width,s.height)-Math.max(i.width,i.height):s.width*s.height-i.width*i.height;return n===0&&i.hash&&s.hash?i.hash>s.hash?-1:1:n})}get currentBinIndex(){return this._currentBinIndex}get dirty(){return this.bins.some(t=>t.dirty)}get rects(){let t=[];for(let e of this.bins)t.push(...e.rects);return t}}function X(l){return l<=0?0:Math.pow(2,Math.ceil(Math.log2(l)))}function se(l,t={}){const{padding:e=0,maxWidth:i=4096}=t,s=[...l].sort((r,y)=>y.width*y.height-r.width*r.height);let n=0,a=0,d=0,o=0,p=0;const m=[];for(const r of s)n+r.width+e>i&&n>0&&(n=0,a+=d+e,d=0),m.push({img:r,x:n,y:a,width:r.width,height:r.height,rotated:!1}),d=Math.max(d,r.height),o=Math.max(o,n+r.width),p=Math.max(p,a+r.height),n+=r.width+e;return t.powerOfTwo&&(o=X(o),p=X(p)),{width:o,height:p,frames:m}}function ae(l,t={}){const e=t.padding??0,i=t.maxWidth??4096,s=t.maxHeight??4096,n=!!t.powerOfTwo,a=t.square??!1,d={smart:t.smart??!0,pot:n,square:a,allowRotation:t.allowRotation??!1,tag:t.tag??!1,exclusiveTag:t.exclusiveTag??!0,border:t.border??0,logic:t.logic==="max-area"?C.MAX_AREA:C.MAX_EDGE},o=l.reduce((w,v)=>w+v.width*v.height,0),p=Math.max(64,Math.ceil(Math.sqrt(o)));let m=Math.min(i,p),r=a?Math.min(s,m):Math.min(s,p);const y=[...l].sort((w,v)=>v.width*v.height-w.width*w.height);for(;m<=i&&r<=s;){const w=new ie(m,r,e,d);for(const _ of y)w.add(_.width,_.height,_);if(w.bins.length===1&&w.bins[0].rects.length===l.length){const U=w.bins[0].rects.map(g=>({img:g.data,x:g.x,y:g.y,width:g.width,height:g.height,rotated:!!g.rot}));let b=U.reduce((g,c)=>Math.max(g,c.x+c.width),0),x=U.reduce((g,c)=>Math.max(g,c.y+c.height),0);if(a){const g=Math.max(b,x);b=g,x=g}if(n&&(b=X(b),x=X(x)),b=Math.min(Math.max(b,1),i),x=Math.min(Math.max(x,1),s),a){const g=Math.min(b,x);b=g,x=g}return{width:b,height:x,frames:U}}if(a){const _=Math.max(m,r)*2,U=n?X(_):_;if(m=Math.min(U,i),r=Math.min(U,s),m===i&&r===s)break}else if(m<i)m=Math.min(i,n?X(m*2):m*2);else if(r<s)r=Math.min(s,n?X(r*2):r*2);else break}throw new Error("图片超出最大尺寸限制，请增大最大宽高或关闭 2 的幂次方限制")}function ne(){const l=I(!1),t=I(null);async function e(i,s={}){l.value=!0,t.value=null;try{if(i.length===0)throw new Error("没有可用的图片");const a=(s.algorithm??"bin-packing")==="bin-packing"?ae(i,s):se(i,s);if(!a.width||!a.height)throw new Error("生成的合图尺寸无效");const d=document.createElement("canvas");d.width=a.width,d.height=a.height;const o=d.getContext("2d");if(!o)throw new Error("无法创建 Canvas 上下文");const p=[];for(const r of a.frames){const y=r.img;if(!y.dataUrl)throw new Error(`图片 ${y.name} 数据缺失`);const w=await vt(y.dataUrl);r.rotated?(o.save(),o.translate(r.x+r.width,r.y),o.rotate(Math.PI/2),o.drawImage(w,0,0,y.width,y.height),o.restore()):o.drawImage(w,r.x,r.y,y.width,y.height),p.push({id:y.id,name:y.name,x:r.x,y:r.y,width:r.width,height:r.height,rotated:r.rotated})}const m={image:"sprite.png",format:"RGBA8888",size:{w:a.width,h:a.height},scale:1,frames:p,meta:{app:"SpriteSheetTool",version:"1.0.0",format:"RGBA8888",size:{w:a.width,h:a.height}}};return{canvas:d,config:m,width:a.width,height:a.height}}catch(n){throw t.value=n instanceof Error?n.message:"合图生成失败",n}finally{l.value=!1}}return{packing:l,error:t,packSprites:e}}const oe=et("sprite",{state:()=>({config:null,spriteImageUrl:null,options:{padding:2,algorithm:"bin-packing",maxWidth:2048,maxHeight:2048,powerOfTwo:!1,smart:!0,square:!1,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:"max-edge"}}),getters:{hasConfig:l=>l.config!==null,hasSpriteImage:l=>l.spriteImageUrl!==null},actions:{setConfig(l){this.config=l},setSpriteImageUrl(l){this.spriteImageUrl=l},updateOptions(l){this.options={...this.options,...l}},clear(){this.spriteImageUrl&&URL.revokeObjectURL(this.spriteImageUrl),this.config=null,this.spriteImageUrl=null}}}),le={class:"pack-view"},he={class:"card-header"},re={class:"card-header"},de={key:0,class:"header-actions"},ce=j({__name:"PackView",setup(l){const{images:t,addImages:e,removeImage:i,clearImages:s}=ee(),{packSprites:n,error:a}=ne(),d=oe(),o=I(null),p=I(!1),m=I("sprite"),r=I({padding:2,algorithm:"bin-packing",maxWidth:2048,maxHeight:2048,powerOfTwo:!1,smart:!0,square:!1,allowRotation:!1,tag:!1,exclusiveTag:!0,border:0,logic:"max-edge"}),y=async g=>{await e(g),await U()},w=async g=>{i(g),await U()},v=()=>{s(),o.value=null},_=async g=>{r.value=g,d.updateOptions(g),await U()},U=async()=>{if(t.value.length===0){o.value=null;return}try{const g=await n(t.value,r.value);o.value=g,d.setConfig(g.config)}catch{L.error(a.value||"合图生成失败")}},b=z(()=>m.value.trim().replace(/[\\/:*?"<>|]/g,"_")||"sprite"),x=async g=>{if(o.value){p.value=!0;try{const c=await xt(o.value.canvas,{format:"png"});if(yt(c,`${b.value}.png`),o.value.config){const R=g==="plist"?"plist":"json";st(o.value.config,`${b.value}.${R}`)}L.success(`导出 ${g.toUpperCase()} 配置成功`)}catch{L.error("导出失败")}finally{p.value=!1}}};return Z(()=>t.value.length,async()=>{t.value.length>0&&await U()}),(g,c)=>{const R=f("el-button"),O=f("el-card"),B=f("el-col"),P=f("el-input"),T=f("el-icon"),A=f("el-dropdown-item"),W=f("el-dropdown-menu"),Q=f("el-dropdown"),ot=f("el-row");return E(),S("div",le,[h(ot,{gutter:20},{default:u(()=>[h(B,{span:8},{default:u(()=>[h(O,{class:"upload-card"},{header:u(()=>[k("div",he,[c[2]||(c[2]=k("span",null,"图片上传",-1)),$(t).length>0?(E(),tt(R,{key:0,type:"danger",size:"small",onClick:v},{default:u(()=>[...c[1]||(c[1]=[V(" 清空 ",-1)])]),_:1})):Y("",!0)])]),default:u(()=>[h(It,{onChange:y}),$(t).length>0?(E(),tt(zt,{key:0,images:$(t),onRemove:w,class:"image-list"},null,8,["images"])):Y("",!0)]),_:1})]),_:1}),h(B,{span:10},{default:u(()=>[h(O,{class:"preview-card"},{header:u(()=>[k("div",re,[c[6]||(c[6]=k("span",null,"合图预览",-1)),o.value?(E(),S("div",de,[h(P,{modelValue:m.value,"onUpdate:modelValue":c[0]||(c[0]=D=>m.value=D),size:"small",placeholder:"导出文件名",class:"filename-input"},null,8,["modelValue"]),h(Q,{onCommand:x},{dropdown:u(()=>[h(W,null,{default:u(()=>[h(A,{command:"json"},{default:u(()=>[...c[4]||(c[4]=[V("导出 JSON 配置",-1)])]),_:1}),h(A,{command:"plist"},{default:u(()=>[...c[5]||(c[5]=[V("导出 PLIST 配置",-1)])]),_:1})]),_:1})]),default:u(()=>[h(R,{type:"primary",loading:p.value},{default:u(()=>[c[3]||(c[3]=V(" 导出合图 ",-1)),h(T,{class:"el-icon--right"},{default:u(()=>[h($(it))]),_:1})]),_:1},8,["loading"])]),_:1})])):Y("",!0)])]),default:u(()=>{var D;return[h(Xt,{canvas:(D=o.value)==null?void 0:D.canvas},null,8,["canvas"])]}),_:1})]),_:1}),h(B,{span:6},{default:u(()=>[h(O,{class:"config-card"},{header:u(()=>[...c[7]||(c[7]=[k("span",null,"配置选项",-1)])]),default:u(()=>{var D;return[h(te,{options:r.value,config:(D=o.value)==null?void 0:D.config,"onUpdate:options":_},null,8,["options","config"])]}),_:1})]),_:1})]),_:1})])}}}),ge=H(ce,[["__scopeId","data-v-651eebf4"]]);export{ge as default};
